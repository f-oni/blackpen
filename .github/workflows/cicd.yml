name: cicd

on: 
  push:
    branches: [ main ]


jobs:
  
    build:
  
      runs-on: ubuntu-latest

      steps:
      
        - uses: actions/checkout@v4
        - name: Use Node.js 
          uses: actions/setup-node@v4 
          with:
            node-version: '21.x'
        - name: Cache Node Modules
          uses: actions/cache@v4
          with:
            path: ~/.npm
            key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock-json') }}
            restore-keys: |
              ${{ runner.os }}-node-

        - name: Install dependencies
          run: npm ci
        - name: Run Linter
          run: npx eslint .
        - name: build
          run: npm run build --if-present
        - name: Run tests
          run: npm test
        - name: Set aws credentials
          uses: aws-actions/configure-aws-credentials@v4
          with:
            aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
            aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            aws-region: eu-north-1
        - name: Generarte Deployment package
          run: zip -r deploy.zip . 
        - name: Deploy to AWS
          run: |
            pip Install awsebcli
            eb init blackpen --region eu-north-1 --platform "Node.js"
            eb use Blackpen-env 
            eb deploy
